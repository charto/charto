// This file is part of charto-leaflet, copyright (c) 2017 BusFaster Ltd.
// Released under the MIT license, see LICENSE.

import * as L from 'leaflet';
import { MapModel } from 'charto-model';
import { autorun } from 'mobx';

export function bindModel(map: L.Map, model: MapModel) {

	function updateView() {
		map.setView(
			{ lat: model.center.x, lng: model.center.y },
			model.zoom,
			{ animate: false }
		);
	}

	function updateModel(e: L.LeafletEvent) {
		const ll = map.getCenter();
		const zoom = map.getZoom();

		if(model.center.x != ll.lat || model.center.y != ll.lng) {
			model.setCenter(ll.lat, ll.lng);
		}

		if(model.zoom != zoom) model.setZoom(zoom);
	}

	updateView();

	autorun(() => {
		const ll = map.getCenter();
		const zoom = map.getZoom();

		if(model.center.x != ll.lat || model.center.y != ll.lng || model.zoom != zoom) {
			updateView();
		}
	});

	map.on('moveend', updateModel);
	map.on('zoomend', updateModel);
}
